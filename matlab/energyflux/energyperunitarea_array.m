
%directory='/storage2/mikeg/results/spic6b0_1_3d/';
%directory='/storage2/mikeg/results/spic5b0_b1G_3d/';
%directory='/storage2/mikeg/results/spic6b0_2_3d/';
% directory='/fastdata/cs1mkg/smaug/spic4b0_3d/';
%directory='/storage2/mikeg/results/spic3p0a_0_2_3d/';
%directory='/storage2/mikeg/results/spic2p3a_0_3_3d/';
%directory='/storage2/mikeg/results/spic6p7a_0_0_3d/';
%directory='/storage2/mikeg/results/spic4p3a_0_1_3d/';
%directory='/storage2/mikeg/results/spic4p3_0_1_3d/';
%directory='/fastdata/cs1mkg/smaug/spic5b0_3_3d/';
%directory='/fastdata/cs1mkg/smaug/spic5b0_2_3d/';

%directory='/fastdata/cs1mkg/smaug/spic4p71a_1_1_3d/';
%  directory='/fastdata/cs1mkg/smaug/spic4b0_3_3d/';
%directory='/fastdata/cs1mkg/smaug/spic6b0_3d_rep/';
% directory='/fastdata/cs1mkg/smaug/spic6b0_1_3d/';
%directory='/fastdata/cs1mkg/smaug/spic6b0_3_3d/';
%directory='/fastdata/cs1mkg/smaug/spic_5b2_2_bv20G/';
directory='/shared/sp2rc2/Shared/simulations/smaug_realpmode/fastdata/cs1mkg/smaug/spic_5b2_2_bv50G/';
%directory='/fastdata/cs1mkg/smaug/spic2p00a_0_1_3d/';
%directory='/fastdata/cs1mkg/smaug/spic2p3a_0_3_3d/';
%directory='/fastdata/cs1mkg/smaug/spic1p79a_0_0_3d/';
%  directory='/fastdata/cs1mkg/smaug/spic0p63a_0_3_3d/';
%directory='/fastdata/cs1mkg/smaug/spic1p33a_0_2_3d/';
%directory='/fastdata/cs1mkg/smaug/spicule1p53a_0_3_3d/';
%directory='/fastdata/cs1mkg/smaug/spic0p63a_0_3_3d/';
%directory='/fastdata/cs1mkg/smaug/spic0p63a_0_3_3d/';
%directory='/fastdata/cs1mkg/smaug/spic2p35a_2_2_3d/';
extension='.out';

% ndirectory='/fastdata/cs1mkg/smaug/spic6b0_3d/images/';

%ndirectory='/storage2/mikeg/results/spic5b0_b1G_3d/images_3d_vsecs/';
%ndirectory='/storage2/mikeg/results/spic6b0_1_3d/images_3d_vsecs/';
%ndirectory='/storage2/mikeg/results/spic6b0_2_3d/images_3d_vsecs/';
%ndirectory='/storage2/mikeg/results/spic4b0_2_3d/images/';
%ndirectory='/storage2/mikeg/results/spic2p3a_0_3_3d/images/';
%ndirectory='/storage2/mikeg/results/spic6p7a_0_0_3d/images/';
%ndirectory='/storage2/mikeg/results/spic3p0a_0_2_3d/images/';
%ndirectory='/storage2/mikeg/results/spic4p3a_0_1_3d/images/';
%ndirectory='/storage2/mikeg/results/spic4p3_0_1_3d/images/';
%ndirectory='/fastdata/cs1mkg/smaug/spic6b0_3_3d/images';
% ndirectory='/fastdata/cs1mkg/smaug/spic4b0_3d/images';
%ndirectory='/fastdata/cs1mkg/smaug/spic4p71a_1_1_3d/images';
% ndirectory='/fastdata/cs1mkg/smaug/spic_5b2_2_bv20G/images';
%ndirectory='/fastdata/cs1mkg/smaug/spic6b0_3d_rep/images';
% ndirectory='/fastdata/cs1mkg/smaug/spic6b0_2_3d/images';
% ndirectory='/fastdata/cs1mkg/smaug/spic6b0_1_3d/images';
%ndirectory='/fastdata/cs1mkg/smaug/spic5b0_2_3d/images';
% ndirectory='/fastdata/cs1mkg/smaug/spic2p35a_2_2_3d/images';

%ndirectory='/fastdata/cs1mkg/smaug/spic2p00a_0_1_3d/images';
%ndirectory='/fastdata/cs1mkg/smaug/spic3p0a_0_2_3d/images';
%ndirectory='/fastdata/cs1mkg/smaug/spic2p3a_0_3_3d/images';
%ndirectory='/fastdata/cs1mkg/smaug/spic2p3a_0_0_3d/images';
%ndirectory='/fastdata/cs1mkg/smaug/spicule2p05a_0_2_3d/images';
%ndirectory='/fastdata/cs1mkg/smaug/spicule1p53a_0_3_3d/images';
%ndirectory='/fastdata/cs1mkg/smaug/spic0p63a_0_3_3d/images';
%ndirectory='/fastdata/cs1mkg/smaug/spic0p63a_0_3_3d/images';
%ndirectory='/fastdata/cs1mkg/smaug/spic0p63a_0_3_3d/images';
ndirectory=[directory,'images'];
nextension='.jpg';

%wspacename='0p63a0_3_3dmatlab_perturb.mat';
%wspacename='1p53a0_3_3dmatlab_perturb.mat';
%wspacename='2p00a0_1_3dmatlab_perturb.mat';
% wspacename='5b2_2_bv25G_matlab_eflux.mat';
% wspacename='s1p79a_0_0_matlab_perturb.mat';
%wspacename='3p0a_3dmatlab_perturb.mat';
%wspacename='4p3a_3dmatlab_perturb.mat';
%wspacename='6p7a_3dmatlab_perturb.mat';
%wspacename='5b0_3dmatlab_perturb.mat';
% wspacename='6b0_3dmatlab_perturb.mat';
% wspacename='6b0_1_3dmatlab_perturb.mat';
%wspacename='0p63a_0_3matlab_perturb.mat';
% wspacename='6b0_2_3dmatlab_perturb.mat';
%wspacename='6b0_3dmatlab_perturb.mat';
%wspacename='4p71a1_1_3dmatlab_perturb.mat';
%wspacename='s0p63a_0_3_matlab_perturb.mat';
%wspacename='5b0_2_3dmatlab_perturb.mat';
% wspacename='4b0_3_3dmatlab_perturb.mat';
%wspacename='2p35a2_2_3dmatlab_perturb.mat';
%  wspacename='0p63a0_3_3dmatlab_perturb.mat';
% wspacename='4b0_3dmatlab_perturb.mat';

wspacename=[directory,'matlabdat/','5b2_2_bv50G_matlab_eflux.mat']




%nt=890;
%nt=889;
%nt=1203;
%nt=1200;
%nt=1700; %6p7a
%nt=1360;
%nt=1000;
%nt=803;


i=0;
%  load(wspacename);
% nt=499;
 nt=928;
%  i=0;
% i=193;
iinit=i+1;

if i==0
%uncomment this block if loop starts from i=1
   esumcorona=0;
   esumtran=0;
   esumchrom=0;
  % 
   edifcorona=0;
   ediftran=0;
   edifchrom=0;
  % 
   ebsumcorona=0;
   ebsumtran=0;
  ebsumchrom=0; 
  % 
   esumfluxcorona=0;
   esumfluxtran=0;
   esumfluxchrom=0;
  
  esumarray=zeros(nt,124);
  esum=zeros(1,124);
end

%for i=1:1089
%for i=1:1385
%period=673.4;
%period=673.4;
%nt=1611;%nt=1182;
%period=179.98;
%nt=1182;

%period=180.0;
% period=133.33;
% period=84.84;
%period=673.4;
%period=425.9;
%period=301.25;
% period=63.63;
% period=205.1;
% period=153.8;
period=300.0;

	R=8.3e+003;
	mu=1.257E-6;
	mu_gas=0.6;
	gamma=1.66667;

for i=iinit:nt %1182
%for i=99:nt    

id=int2str(1000*i);
filename=[directory,'zerospic1__',id,extension];
timetext=['time=',int2str(i),'s'];
imfile=[ndirectory,'im1_',id,nextension];
disp([id filename]);
   fid=fopen(trim(filename));
   %fseek(fid,pictsize(ifile)*(npict(ifile)-1),'bof');
   headline=trim(setstr(fread(fid,79,'char')'));
   it=fread(fid,1,'integer*4'); time=fread(fid,1,'float64');
 
   ndim=fread(fid,1,'integer*4');
   neqpar=fread(fid,1,'integer*4'); 
   nw=fread(fid,1,'integer*4');
   nx=fread(fid,3,'integer*4');
   
   nxs=nx(1)*nx(2)*nx(3);
   varbuf=fread(fid,7,'float64');
   
   gamma=varbuf(1);
   eta=varbuf(2);
   g(1)=varbuf(3);
   g(2)=varbuf(4);
   g(3)=varbuf(5);
   
   
   varnames=trim(setstr(fread(fid,79,'char')'));
   
   for idim=1:ndim
      X(:,idim)=fread(fid,nxs,'float64');
   end
   
   for iw=1:nw
      %fread(fid,4);
      w(:,iw)=fread(fid,nxs,'float64');
      %fread(fid,4);
   end
   
   nx1=nx(1);
   nx2=nx(2);
   nx3=nx(3);
   
   xx=reshape(X(:,1),nx1,nx2,nx3);
   yy=reshape(X(:,2),nx1,nx2,nx3);
   zz=reshape(X(:,3),nx1,nx2,nx3);
   
   
 
  % extract variables from w into variables named after the strings in wnames
wd=zeros(nw,nx1,nx2,nx3);
for iw=1:nw
  
     tmp=reshape(w(:,iw),nx1,nx2,nx3);
     wd(iw,:,:,:)=tmp;
end


%w=tmp(iw);
  

clear tmp; 
   
   
   fclose(fid);




%plot sections through 3d array
   %slice=48;
   x=linspace(0,4,128);
   y=linspace(0,4,128);
   z=linspace(0,6,128);
   
   
   
   
   nrange=3:126;
   
   ax=x(nrange);
   ay=y(nrange);
   az=z(nrange);
   [x1,x2,x3] = meshgrid(ax,ay,az);
   %val1=reshape(wd(2,nrange,nrange,nrange),124,124,124);
   %val2=reshape(wd(1,nrange,nrange,nrange)+wd(10,nrange,nrange,nrange),124,124,124);

     %typedef enum vars {rho, mom1, mom2, mom3, energy, b1, b2, b3,energyb,rhob,b1b,b2b,b3b} CEV;

   %myval=shiftdim(val1./val2,1);
   val1=reshape(wd(5,nrange,nrange,nrange),124,124,124)+reshape(wd(9,nrange,nrange,nrange),124,124,124); %energy
   val2=reshape(wd(5,nrange,nrange,nrange),124,124,124);  %perturbed energy
   val3=reshape(wd(9,nrange,nrange,nrange),124,124,124);  %background energy
   val4=reshape(wd(1,nrange,nrange,nrange),124,124,124)+reshape(wd(10,nrange,nrange,nrange),124,124,124); %density
   val5=reshape(wd(2,nrange,nrange,nrange),124,124,124);  % vertical (x) component momentum
   myval=shiftdim(val1,1);
   myval2=shiftdim(val2,1);
   myval3=shiftdim(val3,1);
   myval4=shiftdim(val4,1);
   myval5=shiftdim(val5,1);
   myval6=shiftdim(reshape(wd(3,nrange,nrange,nrange),124,124,124),1);
   myval7=shiftdim(reshape(wd(4,nrange,nrange,nrange),124,124,124),1);
   
   myval8=shiftdim(reshape(wd(6,nrange,nrange,nrange),124,124,124),1);
   myval9=shiftdim(reshape(wd(7,nrange,nrange,nrange),124,124,124),1);
   myval10=shiftdim(reshape(wd(8,nrange,nrange,nrange),124,124,124),1);

   myval11=shiftdim(reshape(wd(11,nrange,nrange,nrange),124,124,124),1);
   myval12=shiftdim(reshape(wd(12,nrange,nrange,nrange),124,124,124),1);
   myval13=shiftdim(reshape(wd(13,nrange,nrange,nrange),124,124,124),1);
  
   
%    eflux=(gamma-1).*(myval2-((myval5.*myval5+myval6.*myval6+myval7.*myval7)./(2.*myval4))).*(myval5./myval4);
%    eflux=eflux-(gamma-1).*((myval8.*myval8+myval9.*myval9+myval10.*myval10)/2+(myval8.*myval11+myval9.*myval12+myval10.*myval13)).*(myval5./myval4);
%    eflux=eflux+(myval8.*myval11+myval9.*myval12+myval10.*myval13).*(1./(mu)).*(myval5./myval4);
%    eflux=eflux+(myval5.*myval8+myval6.*myval9+myval7.*myval10).*(1./(mu)).*(myval11./myval4);


    eflux=(gamma-1).*(myval2-((myval5.*myval5+myval6.*myval6+myval7.*myval7)./(2.*myval4))).*(myval5./myval4);
    eflux=eflux-(gamma-1).*0.012566.*((myval8.*myval8+myval9.*myval9+myval10.*myval10).*(myval5./myval4))/2;
    eflux=eflux+(myval8.*myval11+myval9.*myval12+myval10.*myval13).*(0.012566).*(myval5./myval4);
    eflux=eflux+(myval5.*myval8+myval6.*myval9+myval7.*myval10).*(0.012566).*(myval11./myval4);


   for ih=1:124
    %total energy
    temp=sum(myval(:,:,ih));
    esum(ih)=sum(temp);
    %perturbed energy
    temp=sum(myval2(:,:,ih));
    esumdif(ih)=sum(temp);
    %background energy
    temp=sum(myval3(:,:,ih));
    ebsum(ih)=sum(temp);
    
    temp=sum(eflux(:,:,ih));
    efluxsum(ih)=sum(temp);
   end

   
   
    efluxarray(i,:)=(efluxsum);
	esumarray(i,:)=(esum);
    edifarray(i,:)=(esumdif./esum);
       
esumcorona=esumcorona+sum(esum(48:124));
esumtran=esumtran+sum(esum(39:47));
esumchrom=esumchrom+sum(esum(1:38)); 

esumfluxcorona=esumfluxcorona+sum(efluxsum(48:124));
esumfluxtran=esumfluxtran+sum(efluxsum(39:47));
esumfluxchrom=esumfluxchrom+sum(efluxsum(1:38));

edifcorona=edifcorona+sum(esumdif(48:124));
ediftran=ediftran+sum(esumdif(39:47));
edifchrom=edifchrom+sum(esumdif(1:38));   

ef1Mmv(i)= sum(efluxarray(: , 20))/i;  %20
ef2Mmv(i)=sum(efluxarray(: , 42))/i;  %42
ef4Mmv(i)=sum(efluxarray(: , 90))/i;  %90
ef5p5Mmv(i)=sum(efluxarray(: , 117))/i; %117

if mod(i,20)==0         
    save(wspacename); 
end

end 

escor=esumcorona/nt;
estran=esumtran/nt;
eschrom=esumchrom/nt;

edcor=edifcorona/nt;
edtran=ediftran/nt;
edchrom=edifchrom/nt;

escorper=period*esumcorona/nt;
estranper=period*esumtran/nt;
eschromper=period*esumchrom/nt;




sumper=escorper+eschromper+estranper;
sume=escor+eschrom+estran;
sumdif=(edcor+edtran+edchrom);


r1=100*escor/sume;
r2=100*eschrom/sume;
r3=100*estran/sume;

r4=100*edcor/sumdif;
r5=100*edchrom/sumdif;
r6=100*edtran/sumdif;

ebsumcorona=ebsumcorona+sum(ebsum(48:124));
ebsumtran=ebsumtran+sum(ebsum(39:47));
ebsumchrom=ebsumchrom+sum(ebsum(1:38)); 

sumeb=ebsumcorona+ebsumtran+ebsumchrom;

r7=100*ebsumcorona/sumeb;
r8=100*ebsumtran/sumeb;
r9=100*ebsumchrom/sumeb;

esumfluxcorona=esumfluxcorona/nt
esumfluxchrom=esumfluxchrom/nt
esumflux=esumfluxtran/nt


ef1Mmv= sum(efluxarray(: , 20))/nt;  %20
ef2Mmv=sum(efluxarray(: , 42))/nt;  %42
ef4Mmv=sum(efluxarray(: , 90))/nt;  %90
ef5p5Mmv=sum(efluxarray(: , 117))/nt; %117


% imfile=[ndirectory,'energyvtime_',id,nextension];
% surf(esumarray','LineStyle','none');
% hold on
% 
% 
% set(gca,'CameraPosition',[400 45 17320.508]);
% set(gca,'YTickLabel',{'0.09';'0.99';'1.94';'2.88';'3.83';'4.77';'5.72';'6.67'})
% colorbar;
% xlabel(gca,'Time (seconds)');
% ylabel(gca,'Height (Mm)');
% title(gca,'Energy Dependence for the 0,1 Mode with a 307.7s Driver'); 
% print('-djpeg', imfile); 
% 
% 
% hold off


save(wspacename);


